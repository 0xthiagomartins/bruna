import json
from datetime import datetime
from collections import Counter, defaultdict

class ReportGenerator:
    def __init__(self, history_store):
        """
        Inicializa o gerador de relatórios com um histórico de conversas.

        Args:
            history_store (dict): Um dicionário com o histórico de conversas, 
            onde cada chave é o session_id e o valor é o objeto ChatMessageHistory.
        """
        self.history_store = history_store

    def extract_interactions(self):
        """
        Extrai todas as interações das sessões de chat para análise e relatório.
        
        Returns:
            list: Uma lista de dicionários contendo detalhes de cada interação.
        """
        interactions = []
        for session_id, history in self.history_store.items():
            for message in history.get_all_messages():
                interaction = {
                    "session_id": session_id,
                    "timestamp": datetime.now().isoformat(),
                    "user_role": message.get("user_role"),
                    "topic_of_interest": message.get("topic_of_interest"),
                    "user_message": message.get("user_message"),
                    "bot_response": message.get("bot_response"),
                    "crisis_level": message.get("crisis_level", None),
                    "suggested_actions": message.get("suggested_actions", None),
                }
                interactions.append(interaction)
        return interactions

    def generate_summary_report(self):
        """
        Gera um relatório resumido com base nas interações.

        Returns:
            dict: Um dicionário contendo dados resumidos para o relatório.
        """
        interactions = self.extract_interactions()
        summary = {
            "total_interactions": len(interactions),
            "topics_of_interest": Counter([i["topic_of_interest"] for i in interactions]),
            "user_roles": Counter([i["user_role"] for i in interactions if i["user_role"]]),
            "crisis_levels": Counter([i["crisis_level"] for i in interactions if i["crisis_level"]]),
        }
        return summary

    def generate_detailed_report(self, output_path="detailed_report.json"):
        """
        Gera um relatório detalhado em JSON com todas as interações.

        Args:
            output_path (str): Caminho para salvar o relatório JSON.
        """
        interactions = self.extract_interactions()
        report = {
            "generated_on": datetime.now().isoformat(),
            "total_interactions": len(interactions),
            "detailed_interactions": interactions,
        }
        with open(output_path, "w") as file:
            json.dump(report, file, indent=4)
        print(f"Relatório detalhado salvo em {output_path}")

    def generate_user_role_analysis(self):
        """
        Gera uma análise com base no papel do usuário e tópicos abordados.

        Returns:
            dict: Um dicionário com a quantidade de interações por papel do usuário e tópicos.
        """
        interactions = self.extract_interactions()
        role_topic_count = defaultdict(lambda: defaultdict(int))
        
        for interaction in interactions:
            role = interaction["user_role"]
            topic = interaction["topic_of_interest"]
            role_topic_count[role][topic] += 1
        
        return role_topic_count
